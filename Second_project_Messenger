/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

package Messenger;

import java.awt.Color;
import java.awt.Dimension;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;

import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;
import javax.swing.text.BadLocationException;
import javax.swing.text.SimpleAttributeSet;
import javax.swing.text.StyleConstants;
import javax.swing.text.StyledDocument;

import MainPage.MainPage;

public class Messengergui extends javax.swing.JFrame {

	MainPage mainP;
	boolean isSendOne = false;
	StyledDocument doc;
	SimpleAttributeSet attr;
	ObjectOutputStream out;
	ObjectInputStream in;
	public String id;

	public Messengergui(MainPage mainP) {
		initComponents();
		this.mainP = mainP;
		this.id = mainP.id;
		System.out.println(this.id);
		doc = jTextPane1.getStyledDocument();
	}

	public void parsing(String serverMsg) {
		String tokens[] = serverMsg.split("\\|");
		switch (tokens[0]) {
		case "400": {
			String from = tokens[1];
			String fromMsg = tokens[2];
			showChat(from, fromMsg);
		}
			break;
		case "500": {
			String from = tokens[1];
			String oneMsg = tokens[2];
			showChatPersonal(from, oneMsg);
		}
			break;
		}
	}

	private void showChatPersonal(String from, String oneMsg) {
		String msg = "" + from + "님 >>" + oneMsg + "보냄" + "\r\n";
		JLabel lb = new JLabel(msg);
		lb.setOpaque(true);
		lb.setPreferredSize(new Dimension(700, 50));

		if (from.equals(this.id)) {
			attr = new SimpleAttributeSet();
			StyleConstants.setAlignment(attr, StyleConstants.ALIGN_RIGHT);
			lb.setForeground(Color.BLACK);
			lb.setBackground(Color.white);
		} else {
			attr = new SimpleAttributeSet();
			StyleConstants.setAlignment(attr, StyleConstants.ALIGN_LEFT);
			lb.setForeground(Color.white);
			lb.setBackground(Color.BLACK);
		}
		setStyle(lb, msg, attr);
	}

	private synchronized void showChat(String from, String msg) {
		// TODO Auto-generated method stub
		String Msg = "" + from + ">>" + msg + "\r\n";
		JLabel lb = new JLabel(Msg);
		lb.setOpaque(true);
		lb.setPreferredSize(new Dimension(700, 40));
		lb.setForeground(Color.BLACK);
		if (from.equals(this.id)) {
			attr = new SimpleAttributeSet();
			StyleConstants.setAlignment(attr, StyleConstants.ALIGN_RIGHT);
			lb.setBackground(Color.orange);
		} else {
			attr = new SimpleAttributeSet();
			StyleConstants.setAlignment(attr, StyleConstants.ALIGN_LEFT);
			lb.setBackground(Color.gray);
		}
		setStyle(lb, msg, attr);
	}
	private synchronized void showChatExit(String from) {
		// TODO Auto-generated method stub
		String Msg = id+ "님이 채팅에서 퇴장하셨습니다." + "\r\n";
		JLabel lb = new JLabel(Msg);
		lb.setOpaque(true);
		lb.setPreferredSize(new Dimension(700, 40));
		lb.setForeground(Color.BLACK);
		if (from.equals(this.id)) {
			attr = new SimpleAttributeSet();
			StyleConstants.setAlignment(attr, StyleConstants.ALIGN_CENTER);
			lb.setBackground(Color.RED);
		} else {
			attr = new SimpleAttributeSet();
			StyleConstants.setAlignment(attr, StyleConstants.ALIGN_CENTER);
			lb.setBackground(Color.RED);
		}
		setStyle(lb, Msg, attr);
	}

	private void setStyle(JLabel lb, String msg, SimpleAttributeSet attr2) {
		// TODO Auto-generated method stub
		int offset = doc.getEndPosition().getOffset() - 1;
		jTextPane1.setCaretPosition(offset);
		jTextPane1.insertComponent(lb);

		// JLabel은 문자열, 아이콘 형태 등 다양하게 표현가능.
		String enter = "\r\n";// 엔터값 끼워넣기
		offset = jTextPane1.getCaretPosition();
		try {
			doc.insertString(offset, enter, attr);
		} catch (BadLocationException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		// 문단 정렬방식
		doc.setParagraphAttributes(offset + 2, msg.length(), attr, true);
		jTextPane1.setCaretPosition(offset + 2);
	}

	/**
	 * This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
	// <editor-fold defaultstate="collapsed" desc="Generated
	// Code">//GEN-BEGIN:initComponents
	private void initComponents() {

		jPanel1 = new javax.swing.JPanel();
		jLabel1 = new javax.swing.JLabel();
		jLabel2 = new javax.swing.JLabel();
		jScrollPane2 = new javax.swing.JScrollPane();
		tableList = new javax.swing.JTable();
		tfMsg = new javax.swing.JTextField();
		jLabel3 = new javax.swing.JLabel();
		logout = new javax.swing.JButton();
		Personal = new javax.swing.JCheckBox();
		jScrollPane3 = new javax.swing.JScrollPane();
		jTextPane1 = new javax.swing.JTextPane();

		setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

		jLabel1.setFont(new java.awt.Font("Consolas", 1, 24)); // NOI18N
		jLabel1.setText("MESSENGER v1.1");

		jLabel2.setIcon(new javax.swing.ImageIcon(getClass().getResource("/messenger/smartphone.png"))); // NOI18N

		tableList.setModel(new javax.swing.table.DefaultTableModel(new Object[][] {

		}, new String[] { "NAME", "DEPT" }));
		jScrollPane2.setViewportView(tableList);

		tfMsg.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {
				tfMsgActionPerformed(evt);
			}
		});

		jLabel3.setIcon(new javax.swing.ImageIcon(getClass().getResource("/messenger/send.png"))); // NOI18N

		logout.setText("EXIT");
		logout.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {
				logoutActionPerformed(evt);
			}
		});

		Personal.setText("Personal");
		Personal.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {
				PersonalActionPerformed(evt);
			}
		});

		jScrollPane3.setViewportView(jTextPane1);

		javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
		jPanel1.setLayout(jPanel1Layout);
		jPanel1Layout.setHorizontalGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
				.addGroup(jPanel1Layout.createSequentialGroup().addGap(159, 159, 159).addComponent(jLabel2)
						.addGap(18, 18, 18).addComponent(jLabel1)
						.addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
				.addGroup(jPanel1Layout.createSequentialGroup()
						.addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
								.addGroup(jPanel1Layout.createSequentialGroup().addComponent(Personal)
										.addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
										.addComponent(tfMsg, javax.swing.GroupLayout.PREFERRED_SIZE, 220,
												javax.swing.GroupLayout.PREFERRED_SIZE)
										.addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
										.addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 36,
												javax.swing.GroupLayout.PREFERRED_SIZE))
								.addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 350,
										javax.swing.GroupLayout.PREFERRED_SIZE))
						.addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
						.addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
								.addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 244,
										javax.swing.GroupLayout.PREFERRED_SIZE)
								.addGroup(javax.swing.GroupLayout.Alignment.TRAILING,
										jPanel1Layout.createSequentialGroup()
												.addComponent(logout, javax.swing.GroupLayout.PREFERRED_SIZE, 159,
														javax.swing.GroupLayout.PREFERRED_SIZE)
												.addGap(38, 38, 38)))
						.addGap(0, 0, Short.MAX_VALUE)));
		jPanel1Layout.setVerticalGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
				.addGroup(jPanel1Layout.createSequentialGroup().addGap(20, 20, 20)
						.addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
								.addComponent(jLabel2).addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 64,
										javax.swing.GroupLayout.PREFERRED_SIZE))
						.addGap(18, 18, 18)
						.addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
								.addGroup(jPanel1Layout.createSequentialGroup()
										.addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 419,
												javax.swing.GroupLayout.PREFERRED_SIZE)
										.addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
										.addComponent(logout, javax.swing.GroupLayout.DEFAULT_SIZE, 24,
												Short.MAX_VALUE))
								.addGroup(jPanel1Layout.createSequentialGroup()
										.addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 412,
												javax.swing.GroupLayout.PREFERRED_SIZE)
										.addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
										.addGroup(jPanel1Layout
												.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
												.addComponent(jLabel3, javax.swing.GroupLayout.DEFAULT_SIZE,
														javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
												.addComponent(tfMsg, javax.swing.GroupLayout.Alignment.TRAILING)
												.addGroup(jPanel1Layout.createSequentialGroup().addComponent(Personal)
														.addGap(0, 0, Short.MAX_VALUE)))))
						.addContainerGap()));

		javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
		getContentPane().setLayout(layout);
		layout.setHorizontalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(
				jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE,
				javax.swing.GroupLayout.PREFERRED_SIZE));
		layout.setVerticalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(
				jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE));

		pack();
	}// </editor-fold>//GEN-END:initComponents

	private void tfMsgActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_tfMsgActionPerformed
		// TODO add your handling code here:
		String sendMsg = tfMsg.getText();
		if (sendMsg == null || sendMsg.trim().isEmpty()) {
			showMsg("보낼 메세지를 입력하세요");
			return;
		}
		sendMessage(sendMsg);
		tfMsg.setText("");
		tfMsg.requestFocus();
	}// GEN-LAST:event_tfMsgActionPerformed

	private void sendMessage(String msg) {
		// TODO Auto-generated method stub
		msg = msg.replace('|', 'ㅣ');
		try {
			if (isSendOne) {
				// 테이블에서 귓속말할 대상자를 선택해야함
				int row = tableList.getSelectedRow();
				if (row < 0) {
					// 선택한 행이 없으면 -1반환
					showMsg("개인 채팅을 보낼 대상 선택");
					return;
				}
				// 500|받을 사람 대화명 | 메세지
				String toChatName = tableList.getValueAt(row, 1).toString();
				if (mainP.id.equals(toChatName)) {
					showMsg("자기자신을 제외한 사람을 선택하시오");
					return;
				}
				String sendMsg = "500|" + toChatName + "|" + msg;
				mainP.out.writeUTF(sendMsg);
				mainP.out.flush();
				String str = "[" + toChatName + "]님에게 보내는 " + msg + "\n";
			}
			// 아닌 경우
			else {
				String sendMsg = "400|" + id + "|" + msg;
				mainP.out.writeUTF(sendMsg);
				mainP.out.flush();
			}
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	public void showMsg(String message) {
		JOptionPane.showMessageDialog(this, message);
	}

	private void logoutActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_logoutActionPerformed
		// TODO add your handling code here:
		int yn = JOptionPane.showConfirmDialog(this, "채팅에서 나갈까요?", "confirm", JOptionPane.YES_NO_OPTION);
		if (yn == 0) {
			this.setVisible(false);
		}
		else return;
	}// GEN-LAST:event_logoutActionPerformed

	private int showConfirmMsg(String msg) {
		// TODO Auto-generated method stub
		int n = JOptionPane.showConfirmDialog(this, msg, "confirm", JOptionPane.YES_NO_OPTION);
		return n;
	}

	private void PersonalActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_PersonalActionPerformed
		// TODO add your handling code here:
		if (Personal.isSelected()) {
			System.out.println("500|" + this.id);
			isSendOne = true;
		} else {
			isSendOne = false;
		}
	}// GEN-LAST:event_PersonalActionPerformed

	/**
	 * @param args the command line arguments
	 */
	public static void main(String args[]) {
		/* Set the Nimbus look and feel */
		// <editor-fold defaultstate="collapsed" desc=" Look and feel setting code
		// (optional) ">
		/*
		 * If Nimbus (introduced in Java SE 6) is not available, stay with the default
		 * look and feel. For details see
		 * http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html
		 */
		try {
			for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
				if ("Nimbus".equals(info.getName())) {
					javax.swing.UIManager.setLookAndFeel(info.getClassName());
					break;
				}
			}
		} catch (ClassNotFoundException ex) {
			java.util.logging.Logger.getLogger(Messengergui.class.getName()).log(java.util.logging.Level.SEVERE, null,
					ex);
		} catch (InstantiationException ex) {
			java.util.logging.Logger.getLogger(Messengergui.class.getName()).log(java.util.logging.Level.SEVERE, null,
					ex);
		} catch (IllegalAccessException ex) {
			java.util.logging.Logger.getLogger(Messengergui.class.getName()).log(java.util.logging.Level.SEVERE, null,
					ex);
		} catch (javax.swing.UnsupportedLookAndFeelException ex) {
			java.util.logging.Logger.getLogger(Messengergui.class.getName()).log(java.util.logging.Level.SEVERE, null,
					ex);
		}
		// </editor-fold>

	}

	// Variables declaration - do not modify//GEN-BEGIN:variables
	private javax.swing.JCheckBox Personal;
	private javax.swing.JButton logout;
	private javax.swing.JLabel jLabel1;
	private javax.swing.JLabel jLabel2;
	private javax.swing.JLabel jLabel3;
	private javax.swing.JPanel jPanel1;
	private javax.swing.JScrollPane jScrollPane2;
	private javax.swing.JScrollPane jScrollPane3;
	private javax.swing.JTextPane jTextPane1;
	public javax.swing.JTable tableList;
	private javax.swing.JTextField tfMsg;
	// End of variables declaration//GEN-END:variables
}
